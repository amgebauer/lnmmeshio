image: python:3.7

before_script:
  - python3.8 -m venv venv
  - . venv/bin/activate

.test: &test
  stage: test
  variables:
    PYTHON_VERSION: ""
  script:
  - pip install tox
  - rm -rf .tox/
  - rm -rf junit.xml
  - tox -e $PYTHON_VERSION
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  rules:
    - when: always
  artifacts:
    reports:
      junit: junit.xml

test_python_3.7:
  <<: *test
  variables:
    PYTHON_VERSION: "py37"
  rules:
    - when: always

test_python_3.8:
  <<: *test
  variables:
    PYTHON_VERSION: "py38"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" || $CI_PIPELINE_SOURCE == "web"'
      when: always
    - when: never

test_python_3.9:
  <<: *test
  variables:
    PYTHON_VERSION: "py39"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" || $CI_PIPELINE_SOURCE == "web"'
      when: always
    - when: never

version_check:
  stage: test
  script:
    - echo "Check whether version already exists"
    - VERSION=$(cat VERSION)
    - echo Version is $VERSION
    - echo Try to install this version via pip
    - if pip install $PACKAGE_NAME==$VERSION --index-url=https://pypi.python.org/simple/ --extra-index-url=https://lnm-heartgroup.pages.gitlab.lrz.de/packages/; then echo Version does already exist; exit 1; else echo Version is unique; fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - when: never


pages:
  stage: deploy
  script:
    - pip install -r requirements-dev.txt --index-url=https://pypi.python.org/simple/ --extra-index-url=https://lnm-heartgroup.pages.gitlab.lrz.de/packages/
    - coverage run --source=$PACKAGE_NAME -m unittest discover test_$PACKAGE_NAME
    - coverage html
    - mv htmlcov/ public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE != "schedule" && $CI_PIPELINE_SOURCE != "web"'
      when: on_success
    - when: never

trigger_pypi:
  stage: deploy
  script:
    - "curl --request POST --form token=$TRIGGER_PYPI_TOKEN --form ref=master https://gitlab.lrz.de/api/v4/projects/50609/trigger/pipeline"
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && ($CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event")'
      when: on_success
    - when: never
