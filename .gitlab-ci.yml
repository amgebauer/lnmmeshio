image: python:3.7

# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
before_script:
  - /home/gebauer/share/anaconda3/bin/python -V # Print out python version for debugging
  - /home/gebauer/share/anaconda3/bin/pip install --user virtualenv
  - /home/gebauer/share/anaconda3/bin/python -m virtualenv venv
  - source venv/bin/activate
  - pip install -r requirements-dev.txt --index-url=https://pypi.python.org/simple/ --extra-index-url=https://lnm-heartgroup.pages.gitlab.lrz.de/packages/

test:
  stage: test
  script:
  - tox
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'

version_check:
  stage: test
  script:
    - echo "Check whether version already exists"
    - VERSION=$(cat VERSION)
    - echo Version is $VERSION
    - echo Try to install this version via pip
    - pip install lnmmeshio==$VERSION --index-url=https://pypi.python.org/simple/ --extra-index-url=https://lnm-heartgroup.pages.gitlab.lrz.de/packages/; if [[ $? == 0 ]]; then exit 1; fi
  only:
  - merge_requests

pages:
  stage: deploy
  dependencies:
    - test
  script:
    - coverage run --source=lnmmeshio -m unittest discover test_meshio
    - coverage html
    - mv htmlcov/ public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - master

trigger_pypi:
  stage: deploy
  script:
  - "curl --request POST --form token=$TRIGGER_PYPI_TOKEN --form ref=master https://gitlab.lrz.de/api/v4/projects/50609/trigger/pipeline"
  only:
    - master
